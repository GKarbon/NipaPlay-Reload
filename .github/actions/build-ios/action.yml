name: 'Build iOS IPA'
description: '构建 iOS 应用并生成 IPA 文件'
inputs:
  app-version:
    description: '应用版本号'
    required: true
outputs:
  ipa-path:
    description: '生成的 IPA 文件路径'
    value: ${{ steps.build.outputs.ipa_path }}
runs:
  using: 'composite'
  steps:
    - name: Setup iOS environment
      shell: bash
      run: |
        echo "检查Xcode版本："
        xcodebuild -version || echo "无法获取Xcode版本"
        echo "设置iOS构建环境..."
    
    - name: Build Web and copy assets
      shell: bash
      run: |
        chmod +x build_and_copy_web.sh
        ./build_and_copy_web.sh
    
    - name: Build iOS
      id: build
      shell: bash
      env:
        IPHONEOS_DEPLOYMENT_TARGET: '13.0'
      run: |
        echo "开始iOS构建流程..."
        echo "当前工作目录: $(pwd)"
        
        echo "更新CocoaPods依赖..."
        cd ios
        pod update --repo-update || echo "Pod update警告，继续构建..."
        cd ..
        
        echo "开始Flutter iOS构建..."
        # 使用可用的iOS SDK版本，设置明确的目标
        flutter build ios --release --no-codesign --verbose
        sh thin-payload.sh build/ios/iphoneos/*.app
        cd build
        mkdir -p Payload
        mv ios/iphoneos/*.app Payload
        ipa_name="NipaPlay_${{ inputs.app-version }}_iOS_arm64.ipa"
        zip -9 "$ipa_name" -r Payload
        echo "ipa_path=build/$ipa_name" >> $GITHUB_OUTPUT

